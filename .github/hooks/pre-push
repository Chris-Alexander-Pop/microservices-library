#!/bin/bash
#
# Pre-push hook for system-design-library
# This hook runs quality gates before allowing a push to the remote.
#
# To enable this hook:
#   cp .github/hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# Or install all hooks:
#   make install-hooks

set -e

echo "ğŸ”’ Running pre-push quality gates..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if we have failures
FAILED=0

# 1. Auto-format code
echo "ğŸ“‹ Formatting code with gofmt..."
gofmt -w .
echo -e "${GREEN}âœ… Formatting applied${NC}"

# Check if formatting created any changes that need to be committed
if ! git diff --quiet; then
    echo -e "${YELLOW}âš ï¸  Formatting changed some files. These changes will be included in your push.${NC}"
    echo "   Changed files:"
    git diff --name-only | sed 's/^/     /'
    echo ""
fi
echo ""

# 2. Run go vet
echo "ğŸ“‹ Running go vet..."
if ! go vet ./... 2>&1; then
    echo -e "${RED}âŒ go vet failed${NC}"
    FAILED=1
else
    echo -e "${GREEN}âœ… go vet OK${NC}"
fi
echo ""

# 3. Build check
echo "ğŸ“‹ Verifying build..."
if ! go build ./... 2>&1; then
    echo -e "${RED}âŒ Build failed${NC}"
    FAILED=1
else
    echo -e "${GREEN}âœ… Build OK${NC}"
fi
echo ""

# 4. Run tests
echo "ğŸ“‹ Running tests..."
if ! go test -race ./pkg/... ./templates/... ./services/... 2>&1; then
    echo -e "${RED}âŒ Tests failed${NC}"
    FAILED=1
else
    echo -e "${GREEN}âœ… Tests OK${NC}"
fi
echo ""

# Final result
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}âŒ Pre-push checks FAILED. Push blocked.${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "To skip this check (not recommended): git push --no-verify"
    exit 1
else
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}ğŸ‰ All pre-push checks passed! Pushing...${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    exit 0
fi
